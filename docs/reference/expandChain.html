<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Expand code objects — expandChain • shinymeta</title>

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>



  <link href="../extra.css" rel="stylesheet">
  
<meta property="og:title" content="Expand code objects — expandChain" />

<meta property="og:description" content="Use expandChain to write code out of one or more metaReactive objects.
Each meta-reactive object (expression, observer, or renderer) will cause not
only its own code to be written, but that of its dependencies as well." />
<meta name="twitter:card" content="summary" />



<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body>
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">shinymeta</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../articles/code-generation.html">Code generation</a>
</li>
<li>
  <a href="../articles/code-distribution.html">Code distribution</a>
</li>
<li>
  <a href="../articles/special-topics.html">Special topics</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
      
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/rstudio/shinymeta">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Expand code objects</h1>
    <small class="dont-index">Source: <a href='https://github.com/rstudio/shinymeta/blob/master/R/metareactive.R'><code>R/metareactive.R</code></a></small>
    <div class="hidden name"><code>expandChain.Rd</code></div>
    </div>

    <div class="ref-description">
    
    <p>Use <code>expandChain</code> to write code out of one or more metaReactive objects.
Each meta-reactive object (expression, observer, or renderer) will cause not
only its own code to be written, but that of its dependencies as well.</p>
    
    </div>

    <pre class="usage"><span class='fu'>newExpansionContext</span>()

<span class='fu'>expandChain</span>(<span class='no'>...</span>, <span class='kw'>.expansionContext</span> <span class='kw'>=</span> <span class='fu'>newExpansionContext</span>())</pre>
    
    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>...</th>
      <td><p>All arguments must be unnamed, and must be one of: 1) calls to
meta-reactive objects, 2) comment string (e.g. <code>"# A comment"</code>), 3)
language object (e.g. <code><a href='https://rdrr.io/r/base/substitute.html'>quote(print(1 + 1))</a></code>), or 4) <code>NULL</code> (which will be
ignored). Calls to meta-reactive objects can optionally be <code><a href='https://rdrr.io/r/base/invisible.html'>invisible()</a></code>,
see Details.</p></td>
    </tr>
    <tr>
      <th>.expansionContext</th>
      <td><p>Accept the default value if calling <code>expandChain</code> a
single time to generate a corpus of code; or create an expansion context
object using <code>newExpansionContext()</code> and pass it to multiple related calls
of <code>expandChain</code>. See Details.</p></td>
    </tr>
    </table>
    
    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>The return value of <code>expandChain()</code> is a code object that's suitable for
printing or passing to <code><a href='displayCodeModal.html'>displayCodeModal()</a></code>, <code><a href='buildScriptBundle.html'>buildScriptBundle()</a></code>, or
<code><a href='buildScriptBundle.html'>buildRmdBundle()</a></code>.</p>
<p>The return value of <code>newExpansionContext</code> is an object that should be
passed to multiple <code>expandChain()</code> calls.</p>
    
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>There are two ways to extract code from meta objects (i.e. <code><a href='metaReactive.html'>metaReactive()</a></code>,
<code><a href='metaObserve.html'>metaObserve()</a></code>, and <code><a href='metaRender.html'>metaRender()</a></code>): <code><a href='withMetaMode.html'>withMetaMode()</a></code> and <code>expandChain()</code>.
The simplest is <code><a href='withMetaMode.html'>withMetaMode(obj())</a></code>, which crawls the tree of meta-reactive
dependencies and expands each <code><a href='dotdot.html'>..()</a></code> in place.</p>
<p>For example, consider these meta objects:</p><pre>    nums &lt;- metaReactive({ runif(100) })
    obs &lt;- metaObserve({
      summary(..(nums()))
      hist(..(nums()))
    })
</pre>

<p>When code is extracted using <code>withMetaMode</code>:</p><pre>    withMetaMode(obs())
</pre>

<p>The result looks like this:</p><pre>    summary(runif(100))
    plot(runif(100))
</pre>

<p>Notice how <code><a href='https://rdrr.io/r/stats/Uniform.html'>runif(100)</a></code> is inlined wherever <code><a href='dotdot.html'>..(nums())</a></code>
appears, which is not desirable if we wish to reuse the same
values for <code><a href='https://rdrr.io/r/base/summary.html'>summary()</a></code> and <code><a href='https://rdrr.io/r/graphics/plot.html'>plot()</a></code>.</p>
<p>The <code>expandChain</code> function helps us workaround this issue
by assigning return values of <code><a href='metaReactive.html'>metaReactive()</a></code> expressions to
a name, then replaces relevant expansion (e.g., <code><a href='dotdot.html'>..(nums())</a></code>)
with the appropriate name (e.g. <code>nums</code>).</p><pre>    expandChain(obs())
</pre>

<p>The result looks like this:</p><pre>    nums &lt;- runif(100)
    summary(nums)
    plot(nums)
</pre>

<p>You can pass multiple meta objects and/or comments to <code>expandChain</code>.</p><pre>    expandChain(
      "# Generate values",
      nums(),
      "# Summarize and plot",
      obs()
    )
</pre>

<p>Output:</p><pre>    # Load data
    nums &lt;- runif(100)
    nums
    # Inspect data
    summary(nums)
    plot(nums)
</pre>

<p>You can suppress the printing of the <code>nums</code> vector in the previous example by
wrapping the <code>nums()</code> argument to <code>expandChain()</code> with <code><a href='https://rdrr.io/r/base/invisible.html'>invisible(nums())</a></code>.</p>
    
    <h2 class="hasAnchor" id="preserving-dependencies-between-expandchain-calls"><a class="anchor" href="#preserving-dependencies-between-expandchain-calls"></a>Preserving dependencies between <code>expandChain()</code> calls</h2>

    


<p>Sometimes we may have related meta objects that we want to generate code for,
but we want the code for some objects in one code chunk, and the code for
other objects in another code chunk; for example, you might be constructing
an R Markdown report that has a specific place for each code chunk.</p>
<p>Within a single <code>expandChain()</code> call, all <code>metaReactive</code> objects are
guaranteed to only be declared once, even if they're declared on by multiple
meta objects; but since we're making two <code>expandChain()</code> calls, we will end
up with duplicated code. To remove this duplication, we need the second
<code>expandChain</code> call to know what code was emitted in the first <code>expandChain</code>
call.</p>
<p>We can achieve this by creating an "expansion context" and sharing it between
the two calls.</p><pre>    exp_ctx &lt;- newExpansionContext()
    chunk1 &lt;- expandChain(.expansionContext = exp_ctx,
      invisible(nums())
    )
    chunk2 &lt;- expandChain(.expansionContext = exp_ctx,
      obs()
    )
</pre>

<p>After this code is run, <code>chunk1</code> contains only the definition of <code>nums</code> and
<code>chunk2</code> contains only the code for <code>obs</code>.</p>
    
    <h2 class="hasAnchor" id="substituting-metareactive-objects"><a class="anchor" href="#substituting-metareactive-objects"></a>Substituting <code>metaReactive</code> objects</h2>

    


<p>Sometimes, when generating code, we want to completely replace the
implementation of a <code>metaReactive</code>. For example, our Shiny app might contain
this logic, using <code><a href='https://rdrr.io/pkg/shiny/man/fileInput.html'>shiny::fileInput()</a></code>:</p><pre>    data &lt;- metaReactive2({
      req(input$file_upload)
      metaExpr(read.csv(..(input$file_upload$datapath)))
    })
    obs &lt;- metaObserve({
      summary(..(data()))
    })
</pre>

<p>Shiny's file input works by saving uploading files to a temp directory. The
file referred to by <code>input$file_upload$datapath</code> won't be available when
another user tries to run the generated code.</p>
<p>You can use the expansion context object to swap out the implementation of
<code>data</code>, or any other <code>metaReactive</code>:</p><pre>    ec &lt;- newExpansionContext()
    ec$substituteMetaReactive(data, function() {
      metaExpr(read.csv("data.csv"))
    })

    expandChain(.expansionContext = ec, obs())
</pre>

<p>Result:</p><pre>    data &lt;- read.csv("data.csv")
    summary(data)
</pre>

<p>Just make sure this code ends up in a script or Rmd bundle that includes the
uploaded file as <code>data.csv</code>, and the user will be able to reproduce your
analysis.</p>
<p>The <code>substituteMetaReactive</code> method takes two arguments: the <code>metaReactive</code>
object to substitute, and a function that takes zero arguments and returns a
quoted expression (for the nicest looking results, use <code>metaExpr</code> to create
the expression). This function will be invoked the first time the
<code>metaReactive</code> object is encountered (or if the <code>metaReactive</code> is defined
with <code>inline = TRUE</code>, then every time it is encountered).</p>
    
    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    <p><a href='https://rstudio.github.io/shinymeta/articles/code-generation.html'>https://rstudio.github.io/shinymeta/articles/code-generation.html</a></p>
    

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='no'>input</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span>(<span class='kw'>dataset</span> <span class='kw'>=</span> <span class='st'>"cars"</span>)

<span class='co'># varname is only required if srcref aren't supported</span>
<span class='co'># (R CMD check disables them for some reason?)</span>
<span class='no'>mr</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='metaReactive.html'>metaReactive</a></span>({
  <span class='fu'><a href='https://rdrr.io/r/base/get.html'>get</a></span>(<span class='fu'><a href='dotdot.html'>..</a></span>(<span class='no'>input</span>$<span class='no'>dataset</span>), <span class='st'>"package:datasets"</span>)
})

<span class='no'>top</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='metaReactive.html'>metaReactive</a></span>({
  <span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span>(<span class='fu'><a href='dotdot.html'>..</a></span>(<span class='fu'>mr</span>()))
})

<span class='no'>bottom</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='metaReactive.html'>metaReactive</a></span>({
  <span class='fu'><a href='https://rdrr.io/r/utils/head.html'>tail</a></span>(<span class='fu'><a href='dotdot.html'>..</a></span>(<span class='fu'>mr</span>()))
})

<span class='no'>obs</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='metaObserve.html'>metaObserve</a></span>({
  <span class='fu'><a href='https://rdrr.io/r/base/message.html'>message</a></span>(<span class='st'>"Top:"</span>)
  <span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span>(<span class='fu'><a href='dotdot.html'>..</a></span>(<span class='fu'>top</span>()))
  <span class='fu'><a href='https://rdrr.io/r/base/message.html'>message</a></span>(<span class='st'>"Bottom:"</span>)
  <span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span>(<span class='fu'><a href='dotdot.html'>..</a></span>(<span class='fu'>bottom</span>()))
})

<span class='co'># Simple case</span>
<span class='fu'>expandChain</span>(<span class='fu'>obs</span>())</div><div class='output co'>#&gt; mr <span style='color: #00BB00;'>&lt;-</span><span> </span><span style='color: #00BBBB;'>get</span><span>(</span><span style='color: #BBBB00;'>"cars"</span><span>, </span><span style='color: #BBBB00;'>"package:datasets"</span><span>)
#&gt; top </span><span style='color: #00BB00;'>&lt;-</span><span> </span><span style='color: #00BBBB;'>head</span><span>(mr)
#&gt; bottom </span><span style='color: #00BB00;'>&lt;-</span><span> </span><span style='color: #00BBBB;'>tail</span><span>(mr)
#&gt; </span><span style='color: #00BBBB;'>message</span><span>(</span><span style='color: #BBBB00;'>"Top:"</span><span>)
#&gt; </span><span style='color: #00BBBB;'>summary</span><span>(top)
#&gt; </span><span style='color: #00BBBB;'>message</span><span>(</span><span style='color: #BBBB00;'>"Bottom:"</span><span>)
#&gt; </span><span style='color: #00BBBB;'>summary</span><span>(bottom)</div><div class='input'>
<span class='co'># Explicitly print top</span>
<span class='fu'>expandChain</span>(<span class='fu'>top</span>(), <span class='fu'>obs</span>())</div><div class='output co'>#&gt; mr </span><span style='color: #00BB00;'>&lt;-</span><span> </span><span style='color: #00BBBB;'>get</span><span>(</span><span style='color: #BBBB00;'>"cars"</span><span>, </span><span style='color: #BBBB00;'>"package:datasets"</span><span>)
#&gt; top </span><span style='color: #00BB00;'>&lt;-</span><span> </span><span style='color: #00BBBB;'>head</span><span>(mr)
#&gt; top
#&gt; bottom </span><span style='color: #00BB00;'>&lt;-</span><span> </span><span style='color: #00BBBB;'>tail</span><span>(mr)
#&gt; </span><span style='color: #00BBBB;'>message</span><span>(</span><span style='color: #BBBB00;'>"Top:"</span><span>)
#&gt; </span><span style='color: #00BBBB;'>summary</span><span>(top)
#&gt; </span><span style='color: #00BBBB;'>message</span><span>(</span><span style='color: #BBBB00;'>"Bottom:"</span><span>)
#&gt; </span><span style='color: #00BBBB;'>summary</span><span>(bottom)</div><div class='input'>
<span class='co'># Separate into two code chunks</span>
<span class='no'>exp_ctx</span> <span class='kw'>&lt;-</span> <span class='fu'>newExpansionContext</span>()
<span class='fu'>expandChain</span>(<span class='kw'>.expansionContext</span> <span class='kw'>=</span> <span class='no'>exp_ctx</span>,
  <span class='fu'><a href='https://rdrr.io/r/base/invisible.html'>invisible</a></span>(<span class='fu'>top</span>()),
  <span class='fu'><a href='https://rdrr.io/r/base/invisible.html'>invisible</a></span>(<span class='fu'>bottom</span>()))</div><div class='output co'>#&gt; mr </span><span style='color: #00BB00;'>&lt;-</span><span> </span><span style='color: #00BBBB;'>get</span><span>(</span><span style='color: #BBBB00;'>"cars"</span><span>, </span><span style='color: #BBBB00;'>"package:datasets"</span><span>)
#&gt; top </span><span style='color: #00BB00;'>&lt;-</span><span> </span><span style='color: #00BBBB;'>head</span><span>(mr)
#&gt; bottom </span><span style='color: #00BB00;'>&lt;-</span><span> </span><span style='color: #00BBBB;'>tail</span><span>(mr)</div><div class='input'><span class='fu'>expandChain</span>(<span class='kw'>.expansionContext</span> <span class='kw'>=</span> <span class='no'>exp_ctx</span>,
  <span class='fu'>obs</span>())</div><div class='output co'>#&gt; </span><span style='color: #00BBBB;'>message</span><span>(</span><span style='color: #BBBB00;'>"Top:"</span><span>)
#&gt; </span><span style='color: #00BBBB;'>summary</span><span>(top)
#&gt; </span><span style='color: #00BBBB;'>message</span><span>(</span><span style='color: #BBBB00;'>"Bottom:"</span><span>)
#&gt; </span><span style='color: #00BBBB;'>summary</span><span>(bottom)</div><div class='input'>
</div></span></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <h2>Contents</h2>
    <ul class="nav nav-pills nav-stacked">
      <li><a href="#arguments">Arguments</a></li>
      
      <li><a href="#value">Value</a></li>

      <li><a href="#details">Details</a></li>

      <li><a href="#preserving-dependencies-between-expandchain-calls">Preserving dependencies between <code>expandChain()</code> calls</a></li>

      <li><a href="#substituting-metareactive-objects">Substituting <code>metaReactive</code> objects</a></li>

      <li><a href="#references">References</a></li>
      
      <li><a href="#examples">Examples</a></li>
    </ul>

  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Joe Cheng, Carson Sievert.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.9100.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


